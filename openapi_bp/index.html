<!doctype html>
<html lang="en">

  <head>
    <meta charset="utf-8">

    <title>OpenApi boilerplate</title>

    <meta name="description" content="Why do I keep getting into these problems?">
    <meta name="author" content="Carmen J. Cabezas">

    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <link rel="stylesheet" href="css/reveal.min.css">
    <link rel="stylesheet" href="css/mios.css">
    <link rel="stylesheet" href="css/theme/default.css" id="theme">

    <!-- For syntax highlighting -->
    <link rel="stylesheet" href="lib/css/zenburn.css">

    <!-- If the query includes 'print-pdf', use the PDF print sheet -->
    <script>
      document.write( '<link rel="stylesheet" href="css/print/' + ( window.location.search.match( /print-pdf/gi ) ? 'pdf' : 'paper' ) + '.css" type="text/css" media="print">' );
    </script>
    <!--[if lt IE 9]>
        <script src="lib/js/html5shiv.js"></script>
    <![endif]-->
  </head>

  <body>

    <div class="reveal">

      <!-- Any section element inside of this container is displayed as a slide -->
      <div class="slides">
        <section>
          <h1>OpenApi boilerplate</h1>
          <small><a href="https://globaldevtools.bbva.com/bitbucket/projects/BBVA_GLOBAL_SECAAS_SWAT_COMPONENTS/repos/go-openapi-bp">https://globaldevtools.bbva.com/bitbucket/projects/BBVA_GLOBAL_SECAAS_SWAT_COMPONENTS/repos/go-openapi-bp</a></small>
            <ul>
              <li class="fragment roll-in">
                Por qué
              </li>
              <li class="fragment roll-in">
                Qué <b>NO</b> es
              </li>
              <li class="fragment roll-in">
                Qué es
              </li>
              <li class="fragment roll-in">
                Cómo: Definición y Configuración
              <li class="fragment roll-in">
                Let's go
              </li>
            </ul>
          </br></br>
          <p>
            <small>Antonio Manuel Amaya Calvo (antoniomanuel.amaya@bbva.com) <BR/> Carmen J. Cabezas (carmen.jimenez.cabezas@bbva.com)</small>
          </p>
        </section>
        <section>
          <section>
            <h2>Por qué OpenApi BP</h2>
            <img src="imgs/porque/idea.png" class="fragment roll-in" data-fragment-index="1">
            <img src="imgs/porque/izqCode.png" class="porque fragment roll-in"  data-fragment-index="1">
            <img src="imgs/porque/izqDoc.png" class="porque fragment roll-in"  data-fragment-index="1">
            <img src="imgs/porque/izqDeliver.png" class="porque fragment roll-in"  data-fragment-index="1">
            <img src="imgs/porque/izqDocToCode.png" class="porque fragment roll-in"  data-fragment-index="1">
            <img src="imgs/porque/izqCodeToDeliver.png" class="porque fragment roll-in"  data-fragment-index="1">
            <img src="imgs/porque/dchaDoc.png" class="porque fragment roll-in"  data-fragment-index="1">
            <img src="imgs/porque/dchaCode.png" class="porque fragment roll-in"  data-fragment-index="1">
            <img src="imgs/porque/dchaDeliver.png" class="porque fragment roll-in"  data-fragment-index="1">
            <img src="imgs/porque/dchaCodeToDoc.png" class="porque fragment roll-in"  data-fragment-index="1">
            <img src="imgs/porque/dchaCodeToCode.png" class="porque fragment roll-in"  data-fragment-index="1">
          </section>
          <section>
            <h2>Qué NO es OpenApi BP</h2>
            <ul>
              <li class="fragment roll-in">No es un generador de código</li>
              <li class="fragment roll-in">No es un framework al uso:
                <ul>
                <li class="fragment roll-in"> No impone restricciones sobre la forma de programar</li>
                <li class="fragment roll-in"> No te obliga a usar ningún modelo de datos específico </li>
                </ul>
              </li>
            </ul>
          </section>
          <section>
            <h2>Qué ES OpenApi BP</h2>
              <span class="fragment roll-in">Es un conjunto de librerías que permiten levantar un servidor</span>
              <span class="fragment roll-in">a partir de la definición del API en formato OpenAPI(swagger) en yaml</span>
            <ul>
              <li class="fragment roll-in">Editor: http://editor.swagger.io</li>
              <li class="fragment roll-in">Con la ventaja:
                <ul>
                  <li class="fragment roll-in">Permite ir de la documentación al código: Sólo se expone lo que está documentado</li>
                  <li class="fragment roll-in">Toda la funcionalidad común ya está hecha</li>
                  <li class="fragment roll-in">Mejor aun, está probada</li>
                  <li class="fragment roll-in">Es muy fácil de integrar</li>
                </ul>
              </li>
          </section>
          <section>
              <h2>RAML vs OpenAPI:</h2>
              <ul>
                <li class="fragment roll-in">OpenAPI tiene más y mejor documentación</li>
                <li class="fragment roll-in">... y ya sabíamos OpenAPI ;)</li>
                <li class="fragment roll-in">Cambiarlo para soportar ambos sería sencillo: PR Welcome!</li>
              </ul>
          </section>
          <section>
            <h2>Cómo</h2>
            <ul>
            <li class="fragment roll-in">Con el uso de dos ficheros:
              <ul>
                <li class="fragment roll-in">Definición: &lt;servicio&gt;.yml</li>
                <li class="fragment roll-in">Configuración: config.json</li>
              <ul>
            </li>
            </ul>
          </section>
        </section>
        <section>
          <section>
            <h2>Ejemplo práctico</h2>
          </section>
          <section>
            <img src="imgs/porque/idea.png" data-fragment-index="1">
          </section>
          <section>
            <h2>Vamos a crear el HolaMundo</h2>
            <span class="fragment roll-in">Tendremos un endpoint que dado un nombre devuelve un saludo</span>
          </section>
          <section>
            <img src="imgs/porque/soloDchaDoc.png" data-fragment-index="1">
          </section>
          <section>
              <h2>Crear fichero de definición</h2>
<pre class="fragment roll-in">
swagger: '2.0'
schemes:
  - https
host: holaMundo.appspot.e3r.io
basePath: /
parameters:
  name:
    name: name
    description: The name
    in: path
    required: true
    type: string
definitions:
  regards:
    description: The regard
    type: string
</pre>
          </section>
          <section>
<pre>
paths:
  '/v1/regards/{name}':
    get:
      summary: Say Hello to {name}
      description: Say Hello to {name}
      operationId: getRegards
      parameters:
        - $ref: '#/parameters/name'
      responses:
        '200':
          description: >-
            Returns an object with the regard elements
          schema:
            $ref: '#/definitions/regards'
        '400':
          description: The request will not succeed.
</pre>
          </section>
          <section>
              <h2>O con un editor más cómodo</h2>
              <img src="imgs/goland/swagger.png" class="fragment roll-in" >
          </section>
          <section>
            <img src="imgs/porque/soloDchaCode.png"  data-fragment-index="1">
          </section>
          <section>
              <h2>Crear proyecto y fichero go.mod</h2>
              <small>
              <ul>
                <li class="fragment roll-in">globaldevtools.bbva.com/bbva_global_secaas_swat_components/go-openapi-bp v1.1.18</li>
                <li class="fragment roll-in">globaldevtools.bbva.com/bbva_global_secaas_swat_components/go-utils v1.0.17</li>
                <li class="fragment roll-in">replace globaldevtools.bbva.com/semaas/deltago v0.0.1 => globaldevtools.bbva.com/semaas/deltago.git v0.0.0-20190305155036-273f50690e18</li>
              </ul>
              </small>
              <img src="imgs/goland/goMod.png" class="fragment roll-in" >
          </section>
          <section>
              <h2>Crear fichero de configuración</h2>
              <!--span class="fragment roll-in"-->
<pre class="fragment roll-in">
{
  "openapiOptions": {
    "port": 8124,
    "listenAt": "0.0.0.0",
    "secureServer": false,
    "generateFnTemplates": true,
    "staticPaths": [
    ],
    "ymlFile": "./holaMundo.yml"
  }
}
</pre>
          </section>
          <section>
              <h2>Crear Servidor</h2>
            <ul>
              <li class="fragment roll-in"><u>config.go:</u>
<pre>
package routes

type Config struct {
  OpenAPIOptions *openapi.Options
}
</pre>
              </li>
              <li class="fragment roll-in"><u >holaMundo.go:</u>
                <pre>
package routes

type HolaMundo struct {
  config *Config
}

func New (config Config) *HolaMundo {     
  return &HolaMundo{
    config: &config,
  }
}
                </pre>
              </li>
            </ul>
          </section>
          <section>
              <h2>Crear main</h2>
<pre class="fragment roll-in">
package main
import (...)

func main() {
  instanceBuilder := func(logger2 logger.Logger, opt interface{}) interface{} {        
    return holaMundo.New(opt.(holaMundo.Config))
  }

  specificConfig := struct {
    ConfigFile string           `flag:"configFile;Configuration file path"`
    Config     holaMundo.Config `configFile:"ConfigFile"`
  }{
    ConfigFile: "./config/config.json",
  }

  if server, err := openapi.GetServerBootStrap(&specificConfig, instanceBuilder);     
     err != nil {
    _, _ = fmt.Fprintf(os.Stderr, "error initializing server: %v", err)
  } else {
    server.Start()
  }

  os.Exit(0)
}
</pre>
          </section>
          <section>
              <h2>Ejecutar</h2>
              <img src="imgs/goland/firstRun.png" class="fragment roll-in" >
          </section>
          <section>
              <h2>Ahora sí</h2>
              <img src="imgs/goland/firstRunOK.png" class="fragment roll-in" >
          </section>
          <section>
            <h2>Bonus track</h2>
            <ul>
              <li class="fragment roll-in">En la salida de la ejecución anterior veíamos las cabeceras:
<pre>
X-Rho-Parentspanid: eb76a877-ee77-4118-93-df-b557380e1b64
X-Rho-Traceid: 5a277244-b394-4a70-8ae3-15d0c3de3fe2
</pre>
                <ul>
                </ul>
              </li>
              <li class="fragment roll-in">Efectivamente OpenAPI-BP nos incluye las cabeceras de trazas y logs si no vienen </li>
              <li class="fragment roll-in">O propaga las que se proporcionen en caso de estar incluidas</li>
            </ul>
          </section>
          <section>
            <h2>Activar trazas</h2>
              <ul>
                <li class="fragment roll-in">En fichero de configuración incluir:
                  <ul>
                    <li class="fragment roll-in">"logLevel": 255 --> Se imprimen todos los niveles por debajo del que se configure
                    <li class="fragment roll-in">"logStart": true, --> Traza de entrada en la llamada</li>
                    <li class="fragment roll-in">"logEnd": true, --> Traza de salida de la llamada</li>
                  </ul>
                </li>
              </ul>
          </section>
          <section>
              <h2>Resultado</h2>
              <img src="imgs/goland/activarTrazas.png" class="fragment roll-in" >
          </section>
        </section>
        <section>
          <section>
             <h2>Activar TLS</h2>
            <ul>
              <li class="fragment roll-in">
                Incluir ficheros con certificado y clave privada
                  <ul>
                    <li>cert.pem</lia>
                    <li>key.pem</li>
                  </ul>
              </li>
              <li class="fragment roll-in">
                En fichero de configuración:
                  <ul>
                    <li>"secureServer": true,</li>
                    <li>"certDir": "./config",</li>
                  </ul>
              </li>
            </ul>
          </section>
          <section>
            <h2>Ejecución</h2>
            <img src="imgs/goland/tls.png" >
          </section>
          <section>
             <h2>Activar mTLS</h2>
            <ul>
              <li class="fragment roll-in">Basta con incluir el fichero con las CAs de clientes que aceptamos</li>
              <li class="fragment roll-in">Y decir en el fichero de configuración donde localizarlo:
<pre>
  "clientCAsPath": "./config/clientCAs.pem"
</pre>
              </li>
            </ul>
          </section>
          <section>
            <h2>Restringir los certificados cliente aceptados</h2>
            <ul>
              <li class="fragment roll-in">Incluir en el fichero de configuracion los Distinguished Name (DN) que aceptamos</li>
              <li class="fragment roll-in">Pueden ser expresiones regulares:
<pre class="fragment roll-in"><small>
"validClientDNs": {
  "personalCert": "CN=.*,OU=Personal Id,OU=Ether Identity,OU=Security Architecture,O=BBVA",
  "architectureTest": "C=ES, ST=Spain, L=Madrid, O=CJC, CN=mybotservice.com"
},
</small></pre>
              </li>
              <li class="fragment roll-in">Cada uno de los campos del DN (CN, OU, etc.) es una expresión independiente</li>
              <li class="fragment roll-in">El orden de los campos no es importante</li>
            </ul>
          </section>
          <section>
            <h2>Llamar sin certificado</h2>
            <img src="imgs/goland/callWithouCert.png" >
          </section>
          <section>
            <h2>Llamar con certificado incorrecto</h2>
            <img src="imgs/goland/callWrongCert.png" >
          </section>
          <section>
            <h2>Llamar con certificado válido</h2>
            <img src="imgs/goland/callCertOK.png" >
          </section>
          <section>
             <img src="imgs/porque/soloDchaDeliver.png">
          </section>
        </section>
        <section>
          <section>
            <h2>Si se presenta el jefe, saludarle más respetuosamente</h2>
             <img class="fragment roll-in" src="imgs/porque/soloDchaCodeToDoc.png" class="fragment roll-in">
          </section>
          <section>
            <ul>
              <li>
                Añadir en el YML un middleware
<pre>
x-implementation-middleware:
  - checkBossCert
</pre>
              </li>
            </ul>
          </section>
          <section>
            <h2>Directamente en el IDE</h2>
            <img src="imgs/goland/middleware.png" >
          </section>
          <section>
            <h2>O en nuestro editor</h2>
            <img src="imgs/goland/middlewareSwagger.png" >
          </section>
          <section>
             <img src="imgs/porque/soloDchaCode.png">
          </section>
          <section>
              <h2>Ejecutar</h2>
              <img src="imgs/goland/checkBoss_ko_run.png" class="fragment roll-in" >
          </section>
          <section>
              <h2>Ahora sí</h2>
              <img src="imgs/goland/checkBoss_ok_run.png" class="fragment roll-in" >
          </section>
          <section>
              <h2>Probar</h2>
              <img src="imgs/goland/testCheckBoss.png" class="fragment roll-in" >
          </section>
          <section>
             <img src="imgs/porque/dchaDeliverWithIteration.png">
          </section>
        </section>
        <section>
          <section>
            <h2>Algunas opciones más</h2>
            <ul>
              <li class="fragment roll-in">Health Check: Expone un endpoint que simplemente devuelve un 200
<pre>
    "AllowEmptyCertMatch": true,
    "internalHealthPath": "/_ihc",
    "logInternalHealthCheck": false
</pre>
              </li>
              <li class="fragment roll-in">Logs: Permite definir el namespace y el mrId para las trazas
<pre>
    "namespace": "swat-work",
    "mrId": "holaMundo",
</pre>
              </li>
            </ul>
          </section>
          <section>
            <h2>Configuración específica de nuestro servidor</h2>
            <ul>
              <li class="fragment roll-in">Si añadimos una sección más ya lo tenemos</li>
            </ul>
            <img class="fragment roll-in" src="imgs/goland/config.png">
          </section>
          <section>
            <h2>Más opciones de definición (yml)</h2>
            <ul>
              <li class="fragment roll-in">Configuración: Función que se ejecuta una vez en el arranque. Ideal para las operaciones de inicialización (Configurar CORS, bbdd, caches...)
<pre>
x-implementation-configuration: loadConfig
</pre>
              </li>
              <li class="fragment roll-in">SecurityDefinitions: Validaciones de seguridad a realizar antes de ejecutar la fc. del endpoint
<pre>
securityDefinitions:
  checkKernelCert:
    type: oauth2
    description: Checks that the client certificate is valid.
    flow: application
    tokenUrl: 'https://server/fake'
    x-implementation-method-name: checkKernelCert
...
paths:
  '/_service/info':
    get:
      ...
      security:
        - checkKernelCert: []

</pre>
              </li>
            </ul>
          </section>
          <section>
            <h2>Tipos de SecurityDefinitions</h2>
<pre>
  basicAuth:
    type: <b><u>basic</u></b>
    description: Pasará al fc. el usr/pwd
    x-implementation-method-name: basicAuthChecker
  apiKeyHeader:
    type: <b><u>apiKey</u></b>
    description: >-
     Para Validar una clave. Pasará a la fc. el valor sacado de "in"
     (header o query) en el parámetro "name"
    in: header
    name: apikey
    x-implementation-method-name: tokenAuth
  bearerToken:
    type: <b><u>bearer</u></b>
    description: >-
       Usado cuando queremos validar un JWT firmado con RSA.
       La fc. implementada debe devolver un puntero a un objeto de tipo
       BearerToken, a partir del método y el path.
       OpenapiBP llamará al método Validate del objeto con el token extraido
       de la cabecera indicada.
    in: header
    name: Authorization
    x-implementation-method-name: bearerTokenValidator
  custom:
    type: <b><u>custom</u></b>
    description: Cualquier tipo no descrito arriba. Recibe la request completa
    x-implementation-method-name: customAuth
</pre>
          </section>
          <section>
            <h2>SecurityDefinitions vs middleware</h2>
            <ul>
              <li class="fragment roll-in">Middleware: realizar "tareas" antes del endpoint pero no para ejecución</li>
              <li class="fragment roll-in">
SecurityDefinitions: Está pensado para realizar verificaciones que si no se satisfacen impidan ejecución del endpoint
              </li>
              <li class="fragment roll-in">Middleware se ejecutan siempre antes de cada endpoint</li>
              <li class="fragment roll-in">SecurityDefinitions sólo se comprueban en aquellos path en los que hayan sido incluidos</li>
            </ul>
          </section>
        </section>
        <section>
          <section>
            <h2>¿Cómo funcionan las security definitions?</h2>
            <ul>
              <li class="fragment roll-in">Una sola condición:
<pre class="fragment roll-in">
paths:
  '/v1/regards/{name}':
    get:
      security:
        - checkArchitectureCert: []
</pre>
              </li>
              <li class="fragment roll-in">Dos condiciones como AND
<pre class="fragment roll-in">
paths:
  '/v1/regards/{name}':
    get:
      security:
        - checkArchitectureCert: [1]
          architectureEndUser: [2]
</pre>
<pre class="fragment roll-in">
Equivale a:
(checkArchitectureCert() && architectureEndUser())
</pre>
              </li>
            </ul>
        </section>
        <section>
            <ul>
              <li class="fragment roll-in">O un OR
<pre class="fragment roll-in">
paths:
  '/v1/regards/{name}':
    get:
      security:
        - checkArchitectureCert: [1]
        - architectureEndUser: [1]
</pre>
<pre class="fragment roll-in">
Equivale a:
(checkArchitectureCert() || architectureEndUser())
</pre>

              </li>
              <li class="fragment roll-in">O todo junto
<pre class="fragment roll-in">
paths:
  '/v1/regards/{name}':
    get:
      security:
        - checkArchitectureCert: [1]
          architectureEndUser: [2]
        - checkArchitectureCert: [2]
          architectureTSecInfo: [1]
</pre>
<pre class="fragment roll-in">Equivale a:
((checkArchitectureCert() && architectureEndUser()) ||
(architectureTSecInf() && checkArchitectureCert()))
</pre>
              </li>
            </ul>
          </section>
          <section>
            <h2>¿Y qué pasa con los contextos?</h2>
            <ul>
              <li class="fragment roll-in">La evaluación funciona en cortocircuito
              </li>
              <li class="fragment roll-in">Si todos los handlers son satisfactorios, el contexto pasado al método (path invocado) será el acumulado de los contextos de todos los elementos en la cadena satisfactoria
              </li>
              <li class="fragment roll-in">Mejor con un ejemplo, supongamos:
<pre class="fragment roll-in">
security:
  - A[2]
    B[1]
  - C[1]
    D[2]
    E[]
</pre>
              </li>
              <li class="fragment roll-in">Si B no tiene éxito A no se ejecuta.
              </li>
              <li class="fragment roll-in">Si B y A tienen éxito, ni C, ni D ni E se ejecutan.
              </li>
              <li class="fragment roll-in">B tiene éxito e introduce la clave 'B' en el contexto y A falla</br>
                <span class="fragment roll-in">además C, D y E son éxito e introducen 'C', 'D' y 'E'</span></br>
                <span class="fragment roll-in">El método llamado tendrá 'C', 'D' y 'E' pero no 'B'</span>
              </li>
            </ul>
          </section>
        </section>
        <section>
          <section>
            <h2>Y esto es todo...<span class="fragment roll-in"> por ahora.</span></h2>
            <h2 class="fragment roll-in">Gracias por la atención</h2>
            <h2 class="fragment roll-in">¿preguntas?</h2>
        </section>
			</div>

		</div>

		<script src="lib/js/head.min.js"></script>
		<script src="js/reveal.min.js"></script>

		<script>

			// Full list of configuration options available here:
			// https://github.com/hakimel/reveal.js#configuration
			Reveal.initialize({
				controls: true,
				progress: true,
				history: true,
				center: true,

				theme: Reveal.getQueryHash().theme, // available themes are in /css/theme
				transition: Reveal.getQueryHash().transition || 'default', // default/cube/page/concave/zoom/linear/fade/none

				// Optional libraries used to extend on reveal.js
				dependencies: [
					{ src: 'lib/js/classList.js', condition: function() { return !document.body.classList; } },
					{ src: 'plugin/markdown/marked.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
					{ src: 'plugin/markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
					{ src: 'plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } },
					{ src: 'plugin/zoom-js/zoom.js', async: true, condition: function() { return !!document.body.classList; } },
					{ src: 'plugin/notes/notes.js', async: true, condition: function() { return !!document.body.classList; } }
					// { src: 'plugin/search/search.js', async: true, condition: function() { return !!document.body.classList; } }
					// { src: 'plugin/remotes/remotes.js', async: true, condition: function() { return !!document.body.classList; } }
				]
			});

		</script>

	</body>
</html>
